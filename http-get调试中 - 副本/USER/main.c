#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "SPI_W500.h"//w5500硬件配置
#include "wizchip_conf.h"//w5500参数配置
#include "loopback.h"//server处理程序
#include "socket.h"//socket库
#include "package.h"//modbus模块
#include "delay.h"//延时
#include "led.h"//lcd
#include "lcd.h"//lcd
#include "key.h"
#include "adc.h"//adc
#include "usart.h"	
#include "timer.h"//周期定时、频率测量
#include "fun.h"//周期定时、频率测量
#include "stmflash.h"//周期定时、频率测量

/***********************************add*******************************************/

/****************************************/
//uint8_t infoint[] = { 0x48, 0x54, 0x54, 0x50, 0x2F, 0x31, 0x2E, 0x31, 0x20, 0x32, 0x30, 0x36, 0x20, 0x50, 0x61, 0x72, 0x74, 0x69, 0x61, 0x6C, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x54, 0x79, 0x70, 0x65, 0x3A, 0x20, 0x61, 0x70, 0x70, 0x6C, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x2F, 0x6F, 0x63, 0x74, 0x65, 0x74, 0x2D, 0x73, 0x74, 0x72, 0x65, 0x61, 0x6D, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x20, 0x30, 0x2D, 0x39, 0x2F, 0x31, 0x32, 0x32, 0x38, 0x38, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x4C, 0x65, 0x6E, 0x67, 0x74, 0x68, 0x3A, 0x20, 0x31, 0x30, 0x0D, 0x0A, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x73, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x0D, 0x0A, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x20, 0x32, 0x2E, 0x33, 0x6B, 0x0D, 0x0A, 0x53, 0x65, 0x74, 0x2D, 0x43, 0x6F, 0x6F, 0x6B, 0x69, 0x65, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x5F, 0x53, 0x49, 0x44, 0x5F, 0x3D, 0x30, 0x2E, 0x31, 0x35, 0x35, 0x38, 0x31, 0x35, 0x38, 0x37, 0x39, 0x38, 0x31, 0x34, 0x33, 0x32, 0x37, 0x3B, 0x20, 0x70, 0x61, 0x74, 0x68, 0x3D, 0x2F, 0x3B, 0x20, 0x48, 0x74, 0x74, 0x70, 0x4F, 0x6E, 0x6C, 0x79, 0x0D, 0x0A, 0x45, 0x54, 0x61, 0x67, 0x3A, 0x20, 0x41, 0x35, 0x42, 0x38, 0x45, 0x30, 0x37, 0x41, 0x38, 0x35, 0x46, 0x30, 0x38, 0x41, 0x38, 0x41, 0x34, 0x39, 0x37, 0x34, 0x31, 0x38, 0x36, 0x44, 0x32, 0x31, 0x39, 0x31, 0x44, 0x41, 0x35, 0x31, 0x0D, 0x0A, 0x4C, 0x61, 0x73, 0x74, 0x2D, 0x4D, 0x6F, 0x64, 0x69, 0x66, 0x69, 0x65, 0x64, 0x3A, 0x20, 0x53, 0x61, 0x74, 0x2C, 0x20, 0x30, 0x38, 0x20, 0x4A, 0x75, 0x6C, 0x20, 0x32, 0x30, 0x31, 0x37, 0x20, 0x30, 0x38, 0x3A, 0x33, 0x39, 0x3A, 0x34, 0x35, 0x20, 0x47, 0x4D, 0x54, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x44, 0x69, 0x73, 0x70, 0x6F, 0x73, 0x69, 0x74, 0x69, 0x6F, 0x6E, 0x3A, 0x20, 0x61, 0x74, 0x74, 0x61, 0x63, 0x68, 0x6D, 0x65, 0x6E, 0x74, 0x3B, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x6E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x75, 0x70, 0x64, 0x61, 0x74, 0x65, 0x2E, 0x62, 0x69, 0x6E, 0x22, 0x3B, 0x0D, 0x0A, 0x0D, 0x0A, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x16, 0xAB };
uint8_t infoint[] = {0x48,0x54,0x54,0x50,0x2F,0x31,0x2E,0x31,0x20,0x32,0x30,0x30,0x20,0x4F,0x4B,0x0D,0x0A,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x54,0x79,0x70,0x65,0x3A,0x20,0x61,0x70,0x70,0x6C,0x69,0x63,0x61,0x74,0x69,0x6F,0x6E,0x2F,0x6F,0x63,0x74,0x65,0x74,0x2D,0x73,0x74,0x72,0x65,0x61,0x6D,0x0D,0x0A,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x4C,0x65,0x6E,0x67,0x74,0x68,0x3A,0x20,0x31,0x30,0x0D,0x0A,0x41,0x63,0x63,0x65,0x70,0x74,0x2D,0x52,0x61,0x6E,0x67,0x65,0x73,0x3A,0x20,0x62,0x79,0x74,0x65,0x73,0x0D,0x0A,0x53,0x65,0x72,0x76,0x65,0x72,0x3A,0x20,0x48,0x46,0x53,0x20,0x32,0x2E,0x33,0x6B,0x0D,0x0A,0x53,0x65,0x74,0x2D,0x43,0x6F,0x6F,0x6B,0x69,0x65,0x3A,0x20,0x48,0x46,0x53,0x5F,0x53,0x49,0x44,0x5F,0x3D,0x30,0x2E,0x33,0x36,0x37,0x39,0x30,0x35,0x33,0x35,0x37,0x33,0x38,0x36,0x39,0x31,0x37,0x3B,0x20,0x70,0x61,0x74,0x68,0x3D,0x2F,0x3B,0x20,0x48,0x74,0x74,0x70,0x4F,0x6E,0x6C,0x79,0x0D,0x0A,0x45,0x54,0x61,0x67,0x3A,0x20,0x33,0x42,0x33,0x30,0x37,0x30,0x36,0x41,0x34,0x38,0x37,0x35,0x31,0x30,0x39,0x42,0x37,0x32,0x32,0x43,0x30,0x37,0x38,0x39,0x45,0x43,0x41,0x35,0x44,0x41,0x44,0x38,0x0D,0x0A,0x4C,0x61,0x73,0x74,0x2D,0x4D,0x6F,0x64,0x69,0x66,0x69,0x65,0x64,0x3A,0x20,0x53,0x75,0x6E,0x2C,0x20,0x30,0x39,0x20,0x4A,0x75,0x6C,0x20,0x32,0x30,0x31,0x37,0x20,0x31,0x32,0x3A,0x30,0x32,0x3A,0x33,0x35,0x20,0x47,0x4D,0x54,0x0D,0x0A,0x43,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x2D,0x44,0x69,0x73,0x70,0x6F,0x73,0x69,0x74,0x69,0x6F,0x6E,0x3A,0x20,0x61,0x74,0x74,0x61,0x63,0x68,0x6D,0x65,0x6E,0x74,0x3B,0x20,0x66,0x69,0x6C,0x65,0x6E,0x61,0x6D,0x65,0x3D,0x22,0x69,0x6E,0x66,0x6F,0x2E,0x62,0x69,0x6E,0x22,0x3B,0x0D,0x0A,0x0D,0x0A,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x12,0x16,0xAB};

//
uint8_t tempint[] = { 0x48, 0x54, 0x54, 0x50, 0x2F, 0x31, 0x2E, 0x31, 0x20, 0x32, 0x30, 0x36, 0x20, 0x50, 0x61, 0x72, 0x74, 0x69, 0x61, 0x6C, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x54, 0x79, 0x70, 0x65, 0x3A, 0x20, 0x61, 0x70, 0x70, 0x6C, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x2F, 0x6F, 0x63, 0x74, 0x65, 0x74, 0x2D, 0x73, 0x74, 0x72, 0x65, 0x61, 0x6D, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x20, 0x30, 0x2D, 0x39, 0x2F, 0x31, 0x32, 0x32, 0x38, 0x38, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x4C, 0x65, 0x6E, 0x67, 0x74, 0x68, 0x3A, 0x20, 0x31, 0x30, 0x0D, 0x0A, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x73, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x0D, 0x0A, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x20, 0x32, 0x2E, 0x33, 0x6B, 0x0D, 0x0A, 0x53, 0x65, 0x74, 0x2D, 0x43, 0x6F, 0x6F, 0x6B, 0x69, 0x65, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x5F, 0x53, 0x49, 0x44, 0x5F, 0x3D, 0x30, 0x2E, 0x31, 0x35, 0x35, 0x38, 0x31, 0x35, 0x38, 0x37, 0x39, 0x38, 0x31, 0x34, 0x33, 0x32, 0x37, 0x3B, 0x20, 0x70, 0x61, 0x74, 0x68, 0x3D, 0x2F, 0x3B, 0x20, 0x48, 0x74, 0x74, 0x70, 0x4F, 0x6E, 0x6C, 0x79, 0x0D, 0x0A, 0x45, 0x54, 0x61, 0x67, 0x3A, 0x20, 0x41, 0x35, 0x42, 0x38, 0x45, 0x30, 0x37, 0x41, 0x38, 0x35, 0x46, 0x30, 0x38, 0x41, 0x38, 0x41, 0x34, 0x39, 0x37, 0x34, 0x31, 0x38, 0x36, 0x44, 0x32, 0x31, 0x39, 0x31, 0x44, 0x41, 0x35, 0x31, 0x0D, 0x0A, 0x4C, 0x61, 0x73, 0x74, 0x2D, 0x4D, 0x6F, 0x64, 0x69, 0x66, 0x69, 0x65, 0x64, 0x3A, 0x20, 0x53, 0x61, 0x74, 0x2C, 0x20, 0x30, 0x38, 0x20, 0x4A, 0x75, 0x6C, 0x20, 0x32, 0x30, 0x31, 0x37, 0x20, 0x30, 0x38, 0x3A, 0x33, 0x39, 0x3A, 0x34, 0x35, 0x20, 0x47, 0x4D, 0x54, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x44, 0x69, 0x73, 0x70, 0x6F, 0x73, 0x69, 0x74, 0x69, 0x6F, 0x6E, 0x3A, 0x20, 0x61, 0x74, 0x74, 0x61, 0x63, 0x68, 0x6D, 0x65, 0x6E, 0x74, 0x3B, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x6E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x75, 0x70, 0x64, 0x61, 0x74, 0x65, 0x2E, 0x62, 0x69, 0x6E, 0x22, 0x3B, 0x0D, 0x0A, 0x0D, 0x0A, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x05 };

uint8_t tempint2[] = { 0x48, 0x54, 0x54, 0x50, 0x2F, 0x31, 0x2E, 0x31, 0x20, 0x32, 0x30, 0x36, 0x20, 0x50, 0x61, 0x72, 0x74, 0x69, 0x61, 0x6C, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x54, 0x79, 0x70, 0x65, 0x3A, 0x20, 0x61, 0x70, 0x70, 0x6C, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x2F, 0x6F, 0x63, 0x74, 0x65, 0x74, 0x2D, 0x73, 0x74, 0x72, 0x65, 0x61, 0x6D, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x20, 0x30, 0x2D, 0x39, 0x2F, 0x31, 0x32, 0x32, 0x38, 0x38, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x4C, 0x65, 0x6E, 0x67, 0x74, 0x68, 0x3A, 0x20, 0x31, 0x30, 0x0D, 0x0A, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2D, 0x52, 0x61, 0x6E, 0x67, 0x65, 0x73, 0x3A, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x0D, 0x0A, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x20, 0x32, 0x2E, 0x33, 0x6B, 0x0D, 0x0A, 0x53, 0x65, 0x74, 0x2D, 0x43, 0x6F, 0x6F, 0x6B, 0x69, 0x65, 0x3A, 0x20, 0x48, 0x46, 0x53, 0x5F, 0x53, 0x49, 0x44, 0x5F, 0x3D, 0x30, 0x2E, 0x31, 0x35, 0x35, 0x38, 0x31, 0x35, 0x38, 0x37, 0x39, 0x38, 0x31, 0x34, 0x33, 0x32, 0x37, 0x3B, 0x20, 0x70, 0x61, 0x74, 0x68, 0x3D, 0x2F, 0x3B, 0x20, 0x48, 0x74, 0x74, 0x70, 0x4F, 0x6E, 0x6C, 0x79, 0x0D, 0x0A, 0x45, 0x54, 0x61, 0x67, 0x3A, 0x20, 0x41, 0x35, 0x42, 0x38, 0x45, 0x30, 0x37, 0x41, 0x38, 0x35, 0x46, 0x30, 0x38, 0x41, 0x38, 0x41, 0x34, 0x39, 0x37, 0x34, 0x31, 0x38, 0x36, 0x44, 0x32, 0x31, 0x39, 0x31, 0x44, 0x41, 0x35, 0x31, 0x0D, 0x0A, 0x4C, 0x61, 0x73, 0x74, 0x2D, 0x4D, 0x6F, 0x64, 0x69, 0x66, 0x69, 0x65, 0x64, 0x3A, 0x20, 0x53, 0x61, 0x74, 0x2C, 0x20, 0x30, 0x38, 0x20, 0x4A, 0x75, 0x6C, 0x20, 0x32, 0x30, 0x31, 0x37, 0x20, 0x30, 0x38, 0x3A, 0x33, 0x39, 0x3A, 0x34, 0x35, 0x20, 0x47, 0x4D, 0x54, 0x0D, 0x0A, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x2D, 0x44, 0x69, 0x73, 0x70, 0x6F, 0x73, 0x69, 0x74, 0x69, 0x6F, 0x6E, 0x3A, 0x20, 0x61, 0x74, 0x74, 0x61, 0x63, 0x68, 0x6D, 0x65, 0x6E, 0x74, 0x3B, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x6E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x75, 0x70, 0x64, 0x61, 0x74, 0x65, 0x2E, 0x62, 0x69, 0x6E, 0x22, 0x3B, 0x0D, 0x0A, 0x0D, 0x0A, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x15 };
/****************************************/
void MySort(uint16_t *p,uint16_t len);




/*
**tcp_server_sta[n]
bit8:连接状态
bit7:接收到数据
bit6:数据发送请求
*/
uint16_t server_port[ CLIENT_MAXNUM]={ 502,3001,3002,3003};//四个监听端口
/********************************end add*******************************************/

//uint8_t rev_buf[2000];//接收缓存
unsigned char TX_RX_BufferSize[][8] = {{4,4,4,4,0,0,0,0},{4,4,4,4,0,0,0,0}};//16K发送缓存分配给8个socket|16K接收缓存分配给8个socket
  wiz_NetInfo gWIZNETINFO = { .mac = {0x00, 0x08, 0xdc,0x00, 0xab, 0xcd}, //本地mac,<-mac should be unique.
                            .ip = {192, 168, 1, 11},//本地ip
                            .sn = {255,255,255,0},//子网掩码一般255.255.255.0
                            .gw = {192, 168, 1, 1},//网管一般设成路由器ip即可
                            .dns = {0,0,0,0},//
                            .dhcp = NETINFO_STATIC };//静态
		//设置超时时间
   wiz_NetTimeout  gWIZTIMEOUT = {.retry_cnt = 5,//重连次数：5
								 .time_100us = 2000};//超时时间：2000*100us=200ms
	 
						 
//unsigned char httpreq[200]={"GET /HFS%20TEMP/update.bin HTTP/1.1\r\n"
//														"Connection: Keep-Alive\r\n"
//														"Range: bytes=0-9\r\n"
//														"\r\n"
//														};
//unsigned char tempbuf[20]="yanlutian";
														
//
//uint8_t data[200];
//int istart = 0, iend = 0;
//int WaitTime = 10;
//char send_buf[200] = "", recv_buf[200] = "";
uint8_t update[BYTESPERREQ];
//uint8_t info[100];
//
//int req_times = 0, req_size = 0;
//模拟响应结果
//char bindata[500] = "";

//模拟响应结果
//uint8_t fileinfo[] = { 0x11, 0x22 };
//unsigned int FileSize = 0, FileCRC = 0;

//
//unsigned int offset1;
//unsigned int offset2;
//
//int ii, k;//临时系数
//
//int HttpRecvLen;

//
//char infochar[500] = "";
//
//
//int iistart=0,iiend=0;
//uint8_t iiint[200];
uint16_t filesize=0;
u32 WriteAddr=0x08010000;//定义app代码起始地址
int main(void)
{
	static uint8_t client_index=0;//必须定义为static，否则slave_modbus_response函数会改变client_index的值,待研究
  unsigned char key;
  NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
	delay_init( 168);//延时初始化
	KEY_Init();
	LCD_Init();
	//ethernet init
	W5500SPIHardWareConfig();//w5500引脚配置及初始化
	ctlwizchip( CW_RESET_WIZCHIP,NULL);//初始化芯片
	ctlwizchip( CW_SET_INTRMASK,NULL);//掩饰中断
  ctlnetwork(CN_SET_TIMEOUT, (void*)&gWIZTIMEOUT);//设置溢出时间
	ctlnetwork(CN_SET_NETINFO, (void*)&gWIZNETINFO);//设置网络参数
	ctlwizchip(CW_INIT_WIZCHIP,(void*)TX_RX_BufferSize);//设置socket缓存大小
	//end ethernet init	
	while(1)
	{		
		
			key = KEY_Scan(0);	
			if( key!= 0)
			{
				if(key==KEY0_PRES)
				{
						filesize=UpdateFileDataGet(update);
						//update write part
						//下面这条指令执行完后程序就会开始运行app代码了，不返回！！！
						((void(*)())(*((vu32*)(0x08010004))))();//跳转到app程序复位地址开始执行用户程序
						/*******************^_^你再也看不见我了^_^*******************/

				}
			}	
			//
			//n个客户端-循环n次
			for( client_index=0;client_index<CLIENT_NUM;client_index++)
			{
				/********************************开始轮询***************************************/
				loopback_server( client_index,NULL,server_port[client_index]);//as tcp server
				/********************************轮询结束***************************************/
			}
			//
	  
			
			
			
	}
}










